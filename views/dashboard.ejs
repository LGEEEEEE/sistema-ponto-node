<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard do Funcionário</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 2em;
            background-color: #f9f9f9;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1,
        h3 {
            color: #2c3e50;
        }

        p {
            line-height: 1.6;
        }

        hr {
            border: 0;
            height: 1px;
            background: #ddd;
        }

        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #bdc3c7; 
        }

        .btn-ponto {
            background-color: #27ae60;
            color: white;
            width: 100%;
        }

        .btn-ponto:hover:not(:disabled) {
            background-color: #229954;
        }

        .btn-logout {
            background-color: #e74c3c;
            color: white;
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        .registros-lista {
            list-style-type: none;
            padding: 0;
        }

        .registros-lista li {
            background-color: #f2f2f2;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .mensagem-info, .mensagem-erro {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .mensagem-erro {
            color: #c0392b;
            background-color: #fbeae5;
        }
         .mensagem-info {
            color: #155724;
            background-color: #d4edda;
        }

        .link-rh, .link-relatorio {
            margin-top: 15px;
            display: block;
            text-align: center;
        }
        .link-relatorio {
             text-decoration: underline;
             font-size: 0.9em;
        }

        /* ESTILOS DA CÂMERA */
        .camera-box {
            text-align: center;
            margin-bottom: 15px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            width: 100%;
            max-width: 320px; /* Tamanho para mobile */
            margin: 0 auto 15px auto;
            min-height: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #video-preview {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1); /* Espelhar */
        }
        .camera-erro {
            color: white;
            padding: 20px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Ponto Eletrônico</h1>

        <% if (locals.user) { %>
            <p>Olá, <strong><%= user.nome %></strong>!</p>
        <% } %>

        <% if (locals.query && query.mensagem === 'ciclo_finalizado') { %>
            <p class="mensagem-erro">Você já completou as 4 batidas de ponto do dia!</p>
        <% } else if (locals.query && query.msg === 'ponto_registrado') { %>
             <p class="mensagem-info">Ponto registrado com sucesso!</p>
        <% } else if (locals.query && query.erro === 'foto_obrigatoria') { %>
            <p class="mensagem-erro">Você precisa permitir a câmera para bater o ponto!</p>
        <% } else if (locals.query && query.erro === 'falha_geral') { %>
             <p class="mensagem-erro">Ocorreu um erro ao enviar. Tente novamente.</p>
        <% } %>

        <div class="camera-box">
            <video id="video-preview" autoplay playsinline muted></video>
            <div id="camera-erro-msg" class="camera-erro">Aguardando permissão da câmera...</div>
        </div>
        
        <canvas id="canvas-capture" style="display: none;"></canvas>

        <form id="form-registrar-ponto">
            <button id="btn-bater-ponto" type="submit" class="btn-ponto" disabled>INICIANDO CÂMERA...</button>
        </form>
        
        <hr>

        <h3>Seus registros de hoje:</h3>
        <ul class="registros-lista">
            <% if (registros && registros.length > 0) { %>
                <% registros.forEach(registro => { %>
                    <li><strong><%= registro.tipo %>:</strong>
                        <%= new Date(registro.timestamp).toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' }) %>
                    </li>
                <% }) %>
            <% } else { %>
                <li>Nenhum registro hoje.</li>
            <% } %>
        </ul>

        <hr>

        <% if (locals.user && user.role === 'rh') { %>
            <a href="/rh/dashboard" class="link-rh">Acessar Área do RH</a>
        <% } %>

         <a href="/meu-relatorio" class="link-relatorio">Ver meu relatório detalhado</a>

        <form action="/logout" method="POST" style="margin-top: 15px;">
            <button type="submit" class="btn-logout">Sair</button>
        </form>

    </div>

    <script>
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('canvas-capture');
        const btnBaterPonto = document.getElementById('btn-bater-ponto');
        const formRegistrar = document.getElementById('form-registrar-ponto');
        const cameraErroMsg = document.getElementById('camera-erro-msg');
        let streamAtivo = null;

        // 1. INICIAR CÂMERA AO CARREGAR
        async function iniciarCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: { ideal: 640 } } 
                });
                video.srcObject = stream;
                streamAtivo = stream;
                
                // Quando o vídeo começar a tocar, habilita o botão
                video.onloadedmetadata = () => {
                    video.play(); // Garante play em mobile
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const cicloFinalizado = urlParams.get('mensagem') === 'ciclo_finalizado';
                    
                    if (!cicloFinalizado) {
                        btnBaterPonto.disabled = false;
                        btnBaterPonto.textContent = 'BATER PONTO AGORA';
                    } else {
                        btnBaterPonto.textContent = 'CICLO DO DIA FINALIZADO';
                    }
                };
            } catch (err) {
                console.error("Erro na câmera:", err);
                video.style.display = 'none';
                cameraErroMsg.style.display = 'block';
                cameraErroMsg.textContent = 'Erro: Você precisa permitir a câmera para bater o ponto.';
                btnBaterPonto.textContent = 'CÂMERA BLOQUEADA';
            }
        }

        // Inicia imediatamente
        iniciarCamera();

        // ... (código anterior da câmera) ...

        // 2. ENVIO DO FORMULÁRIO CORRIGIDO
        formRegistrar.addEventListener('submit', function(event) {
            event.preventDefault();

            if (btnBaterPonto.disabled) return;

            if (!confirm("Confirmar registro de ponto com foto?")) return;

            btnBaterPonto.disabled = true;
            btnBaterPonto.textContent = 'Enviando foto...';

            // Captura o frame do vídeo no canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Desenha espelhado
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Converte canvas para Blob
            canvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('foto', blob, 'selfie.jpg'); 

                // Envia via Fetch
                fetch('/registrar', {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    // SE FOR REDIRECIONAMENTO (SUCESSO)
                    if (response.redirected) {
                        window.location.href = response.url; 
                        return;
                    }

                    // SE FOR ERRO (403, 500, etc)
                    if (!response.ok) {
                        const textoResposta = await response.text();
                        
                        // Se a resposta for uma página HTML (nossa página de erro)
                        if (textoResposta.includes('<!DOCTYPE html>')) {
                            document.open();
                            document.write(textoResposta); // <-- AQUI ESTÁ A MÁGICA
                            document.close();
                        } else {
                            // Se for um erro de texto simples
                            alert("Erro: " + textoResposta);
                            btnBaterPonto.disabled = false;
                            btnBaterPonto.textContent = 'TENTAR NOVAMENTE';
                        }
                    } else {
                        // Caso raro onde é OK mas não redirecionou
                        window.location.reload();
                    }
                })
                .catch(err => {
                    console.error("Erro no envio:", err);
                    alert("Erro de conexão ao enviar. Verifique sua internet.");
                    btnBaterPonto.disabled = false;
                    btnBaterPonto.textContent = 'TENTAR NOVAMENTE';
                });
            }, 'image/jpeg', 0.7);
        });
    </script>
</body>
</html>