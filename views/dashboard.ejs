<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard do Funcion√°rio</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; /* Reset margem para mobile */
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1, h3 {
            color: #2c3e50;
        }

        p {
            line-height: 1.6;
        }

        hr {
            border: 0;
            height: 1px;
            background: #ddd;
        }

        button {
            padding: 12px 15px; /* Bot√µes maiores para toque */
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #bdc3c7; 
        }

        .btn-ponto {
            background-color: #27ae60;
            color: white;
            width: 100%;
            font-weight: bold;
        }

        .btn-ponto:hover:not(:disabled) {
            background-color: #229954;
        }

        .btn-logout {
            background-color: #e74c3c;
            color: white;
            width: 100%; /* Bot√£o sair full width no mobile */
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        .registros-lista {
            list-style-type: none;
            padding: 0;
        }

        .registros-lista li {
            background-color: #f2f2f2;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between; /* Alinha tipo e hora */
        }

        .mensagem-info, .mensagem-erro {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .mensagem-erro {
            color: #c0392b;
            background-color: #fbeae5;
            border: 1px solid #f5c6cb;
        }
         .mensagem-info {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .link-rh, .link-relatorio {
            margin-top: 20px;
            display: block;
            text-align: center;
            color: #3498db;
            text-decoration: none;
        }
        .link-relatorio {
             text-decoration: underline;
             font-size: 0.95em;
        }

        /* ESTILOS DA C√ÇMERA */
        .camera-box {
            text-align: center;
            margin-bottom: 15px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            width: 100%;
            max-width: 320px; /* Tamanho ideal */
            margin: 0 auto 20px auto;
            min-height: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Preenche o quadrado sem distorcer */
            display: block;
            transform: scaleX(-1); /* Espelhar */
        }
        .camera-erro {
            color: white;
            padding: 20px;
            display: none;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Ponto Eletr√¥nico</h1>

        <% if (locals.user) { %>
            <p>Ol√°, <strong><%= user.nome %></strong>!</p>
        <% } %>

        <% if (locals.query && query.mensagem === 'ciclo_finalizado') { %>
            <p class="mensagem-erro">Voc√™ j√° completou as 4 batidas de ponto do dia!</p>
        <% } else if (locals.query && query.msg === 'ponto_registrado') { %>
             <p class="mensagem-info">‚úÖ Ponto registrado com sucesso!</p>
        <% } else if (locals.query && query.erro === 'foto_obrigatoria') { %>
            <p class="mensagem-erro">üì∏ Voc√™ precisa permitir a c√¢mera para bater o ponto!</p>
        <% } else if (locals.query && query.erro === 'falha_geral') { %>
             <p class="mensagem-erro">‚ùå Ocorreu um erro ao enviar. Tente novamente.</p>
        <% } %>

        <div class="camera-box">
            <video id="video-preview" autoplay playsinline muted></video>
            <div id="camera-erro-msg" class="camera-erro">Aguardando permiss√£o da c√¢mera...</div>
        </div>
        
        <canvas id="canvas-capture" style="display: none;"></canvas>

        <form id="form-registrar-ponto">
            <button id="btn-bater-ponto" type="submit" class="btn-ponto" disabled>INICIANDO C√ÇMERA...</button>
        </form>
        
        <hr>

        <h3>Seus registros de hoje:</h3>
        <ul class="registros-lista">
            <% if (registros && registros.length > 0) { %>
                <% registros.forEach(registro => { %>
                    <li>
                        <strong><%= registro.tipo %></strong>
                        <span><%= new Date(registro.timestamp).toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit' }) %></span>
                    </li>
                <% }) %>
            <% } else { %>
                <li style="text-align: center; color: #777;">Nenhum registro hoje.</li>
            <% } %>
        </ul>

        <hr>

        <a href="/meu-relatorio" class="link-relatorio">Ver meu relat√≥rio detalhado</a>

        <% if (locals.user && user.role === 'rh') { %>
            <a href="/rh/dashboard" class="link-rh">Acessar √Årea do RH</a>
        <% } %>

        <form action="/logout" method="POST" style="margin-top: 20px;">
            <button type="submit" class="btn-logout">Sair</button>
        </form>

    </div>

    <script>
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('canvas-capture');
        const btnBaterPonto = document.getElementById('btn-bater-ponto');
        const formRegistrar = document.getElementById('form-registrar-ponto');
        const cameraErroMsg = document.getElementById('camera-erro-msg');
        let streamAtivo = null;

        // 1. INICIAR C√ÇMERA AO CARREGAR
        async function iniciarCamera() {
            try {
                // Tenta c√¢mera frontal com resolu√ß√£o ideal balanceada
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                video.srcObject = stream;
                streamAtivo = stream;
                
                // Quando o v√≠deo come√ßar a tocar, habilita o bot√£o
                video.onloadedmetadata = () => {
                    video.play(); // Garante play em mobile (iOS requer isso)
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const cicloFinalizado = urlParams.get('mensagem') === 'ciclo_finalizado';
                    
                    if (!cicloFinalizado) {
                        btnBaterPonto.disabled = false;
                        btnBaterPonto.textContent = 'BATER PONTO AGORA';
                    } else {
                        btnBaterPonto.textContent = 'CICLO DO DIA FINALIZADO';
                    }
                };
            } catch (err) {
                console.error("Erro na c√¢mera:", err);
                video.style.display = 'none';
                cameraErroMsg.style.display = 'block';
                cameraErroMsg.textContent = 'Erro: Voc√™ precisa permitir a c√¢mera no navegador para registrar o ponto.';
                btnBaterPonto.textContent = 'C√ÇMERA BLOQUEADA';
            }
        }

        // Inicia imediatamente
        iniciarCamera();

        // 2. ENVIO DO FORMUL√ÅRIO COM OTIMIZA√á√ÉO DE IMAGEM
        formRegistrar.addEventListener('submit', function(event) {
            event.preventDefault();

            if (btnBaterPonto.disabled) return;

            if (!confirm("Confirmar registro de ponto com foto?")) return;

            btnBaterPonto.disabled = true;
            btnBaterPonto.textContent = 'Processando e enviando...';

            // --- OTIMIZA√á√ÉO: Reduzir tamanho da imagem ---
            const larguraFinal = 320; // 320px √© suficiente para reconhecimento e muito leve
            const escala = larguraFinal / video.videoWidth;
            const alturaFinal = video.videoHeight * escala;

            canvas.width = larguraFinal;
            canvas.height = alturaFinal;
            const ctx = canvas.getContext('2d');
            
            // Desenha espelhado (para ficar igual ao preview que o usu√°rio v√™)
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            // Desenha a imagem redimensionada
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Converte canvas para Blob (arquivo JPG comprimido)
            canvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('foto', blob, 'selfie.jpg'); 

                // Envia via Fetch
                fetch('/registrar', {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    // SE FOR REDIRECIONAMENTO (SUCESSO)
                    if (response.redirected) {
                        window.location.href = response.url; 
                        return;
                    }

                    // SE FOR ERRO (403, 500, etc)
                    if (!response.ok) {
                        const textoResposta = await response.text();
                        
                        // Se a resposta for uma p√°gina HTML (nossa p√°gina de erro generico)
                        if (textoResposta.includes('<!DOCTYPE html>')) {
                            document.open();
                            document.write(textoResposta); // Renderiza o HTML de erro do servidor
                            document.close();
                        } else {
                            // Se for um erro de texto simples
                            alert("Erro do Servidor: " + textoResposta);
                            btnBaterPonto.disabled = false;
                            btnBaterPonto.textContent = 'TENTAR NOVAMENTE';
                        }
                    } else {
                        // Caso raro onde √© OK mas n√£o redirecionou (reload por seguran√ßa)
                        window.location.reload();
                    }
                })
                .catch(err => {
                    console.error("Erro no envio:", err);
                    alert("Erro de conex√£o ao enviar. Verifique sua internet.");
                    btnBaterPonto.disabled = false;
                    btnBaterPonto.textContent = 'TENTAR NOVAMENTE';
                });
            }, 'image/jpeg', 0.6); // Qualidade 60% (Equil√≠brio perfeito entre tamanho e visualiza√ß√£o)
        });
    </script>
</body>
</html>