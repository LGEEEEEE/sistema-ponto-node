<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folha de Ponto Detalhada</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f9f9f9; color: #333; }
        h1, h2 { color: #2c3e50; }
        h2 small { color: #555; font-size: 0.8em; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .filtro-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filtro-box form { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .filtro-box label { font-weight: bold; }
        .filtro-box select, .filtro-box input, .filtro-box button { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .filtro-box button { background-color: #2980b9; color: white; cursor: pointer; }
        .download-button { background-color: #27ae60; color: white; padding: 10px 15px; border-radius: 4px; text-decoration: none; margin-top: 20px; display: inline-block; }
        .download-button:hover { background-color: #229954; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .observacao-falta { color: #e74c3c; font-weight: bold; }
        .observacao-férias { color: #2980b9; font-weight: bold; }
        .observacao-fim-de-semana { color: #7f8c8d; }
        .saldo-positivo { color: #27ae60; }
        .saldo-negativo { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>Folha de Ponto Detalhada</h1>
    <p><a href="/rh/dashboard">← Voltar para a Dashboard do RH</a></p>

    <div class="filtro-box">
        <form action="/rh/relatorios/folha-ponto" method="GET">
            <label for="dataInicio">De:</label>
            <input type="date" id="dataInicio" name="dataInicio" value="<%= dataInicioSelecionada %>" required>
            
            <label for="dataFim">Até:</label>
            <input type="date" id="dataFim" name="dataFim" value="<%= dataFimSelecionada %>" required>

            <label for="funcionarioId">Funcionário:</label>
            <select name="funcionarioId" id="funcionarioId" required>
                <option value="">Selecione um funcionário</option>
                <option value="todos" <%= funcionarioIdSelecionado == 'todos' ? 'selected' : '' %>>Todos os Funcionários</option>
                <% if (listaFuncionarios) { %>
                    <% listaFuncionarios.forEach(func => { %>
                        <option value="<%= func.id %>" <%= funcionarioIdSelecionado == func.id ? 'selected' : '' %>>
                            <%= func.nome %>
                        </option>
                    <% }) %>
                <% } %>
            </select>
            
            <button type="submit">Gerar Relatório</button>
        </form>
    </div>

    <% if (relatorio) { %>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
            <div>
                <% if (funcionario) { %>
                    <h2>Relatório para <%= funcionario.nome %></h2>
                <% } else { %>
                    <h2>Relatório para Todos os Funcionários</h2>
                <% } %>
                <p style="font-size: 1.1em; margin-top: 0;">
                    <strong>Período:</strong> <%= new Date(dataInicioSelecionada + 'T12:00:00').toLocaleDateString('pt-BR') %> 
                    até <%= new Date(dataFimSelecionada + 'T12:00:00').toLocaleDateString('pt-BR') %>
                </p>
            </div>
            <a href="/rh/relatorios/folha-ponto/download?dataInicio=<%= dataInicioSelecionada %>&dataFim=<%= dataFimSelecionada %>&funcionarioId=<%= funcionarioIdSelecionado %>" class="download-button">
                Baixar CSV
            </a>
        </div>

        <table>
            <thead>
                <tr>
                    <% if (funcionarioIdSelecionado === 'todos') { %>
                        <th>Funcionário</th>
                    <% } %>
                    <th>Data</th>
                    <th>Dia da Semana</th>
                    <th>Registros</th>
                    <th>Total Trabalhado</th>
                    <th>Saldo do Dia</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody>
                <% if (relatorio.length > 0) { %>
                    <% relatorio.forEach(dia => { %>
                        <tr>
                            <% if (funcionarioIdSelecionado === 'todos') { %>
                                <td><strong><%= dia.funcionarioNome %></strong></td>
                            <% } %>
                            <td><%= dia.data.toLocaleDateString('pt-BR') %></td>
                            <td><%= dia.data.toLocaleDateString('pt-BR', { weekday: 'long' }) %></td>
                            <td>
                                <ul style="margin: 0; padding-left: 15px;">
                                    <% dia.registros.forEach(r => { %>
                                        <li><strong><%= r.tipo %>:</strong> <%= new Date(r.timestamp).toLocaleTimeString('pt-BR') %></li>
                                    <% }) %>
                                </ul>
                            </td>
                            <td><%= dia.horasTrabalhadas %></td>
                            <td class="<%= dia.saldoHoras.startsWith('+') ? 'saldo-positivo' : (dia.saldoHoras.startsWith('-') ? 'saldo-negativo' : '') %>">
                                <strong><%= dia.saldoHoras %></strong>
                            </td>
                            <td class="observacao-<%= dia.observacao.toLowerCase().replace(' ', '-') %>">
                                <%= dia.observacao %>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="<%= funcionarioIdSelecionado === 'todos' ? 7 : 6 %>" style="text-align: center;">Nenhum dado encontrado para o período e seleção.</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    <% } else { %>
        <p>Selecione um período e um funcionário para gerar o relatório.</p>
    <% } %>

</body>
</html>